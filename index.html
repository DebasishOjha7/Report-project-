<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-Shift Vehicle Dashboard</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        body { background: #1a1f2b; color: white; font-family: sans-serif; padding: 15px; margin: 0; }
        header { text-align: center; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { padding: 15px; border-radius: 10px; text-align: center; transition: 0.3s; }
        .card .val { font-size: 1.5rem; font-weight: bold; }
        .card .label { font-size: 0.6rem; text-transform: uppercase; margin-top: 5px; opacity: 0.8; }
        
        .blue { background: #2563eb; } .green { background: #16a34a; } 
        .orange { background: #ea580c; } .red { background: #dc2626; } 
        .dark-red { background: #7f1d1d; }

        .glass { background: #242936; padding: 20px; border-radius: 15px; border: 1px solid #374151; margin-bottom: 20px; }
        .middle-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        .chart-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .donut-wrapper { position: relative; width: 130px; height: 130px; display: flex; align-items: center; justify-content: center; margin: 15px 0; }
        .donut-inner { position: absolute; font-size: 1.5rem; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; color: #9ca3af; padding: 10px; border-bottom: 1px solid #374151; }
        td { padding: 10px; border-bottom: 1px solid #1f2937; }

        .proof-cell { display: flex; flex-direction: column; gap: 5px; min-width: 150px; }
        .file-input { display: none; }
        .attach-btn { cursor: pointer; color: #3b82f6; font-size: 0.7rem; display: flex; align-items: center; gap: 5px; }
        .img-preview { max-width: 100px; margin-top: 5px; display: none; border: 1px solid #374151; border-radius: 4px; }
        .img-preview img { width: 100%; height: auto; }
        
        .add-btn { background: #3b82f6; border: none; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .refresh-btn { background: #4b5563; border: none; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        .del-btn { background: #ef4444; color: white; border: none; border-radius: 4px; width: 22px; height: 22px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1 contenteditable="true">C-SHIFT VEHICLE STATUS DASHBOARD - KASIA</h1>
            <p id="date-display" contenteditable="true">11-02-2026</p>
        </header>

        <div class="stats-grid">
            <div class="card blue"><i data-lucide="truck"></i><div class="val" id="total-count">0</div><div class="label">Total</div></div>
            <div class="card green"><i data-lucide="arrow-up-circle"></i><div class="val" id="moving-count">0</div><div class="label">Moving</div></div>
            <div class="card orange"><i data-lucide="coffee"></i><div class="val" id="idling-count">0</div><div class="label">Idling</div></div>
            <div class="card red"><i data-lucide="octagon"></i><div class="val" id="stopped-count">0</div><div class="label">Stopped</div></div>
            <div class="card dark-red"><i data-lucide="clock"></i><div class="val" id="offline-count">0</div><div class="label">Offline</div></div>
        </div>

        <div class="middle-section">
            <div class="table-container glass">
                <div class="table-header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>DESTINATION-WISE STATUS</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="refresh-btn" onclick="refreshDashboard()">ðŸ”„ Refresh Sheet</button>
                        <button class="add-btn" onclick="addDestinationRow()">+ Add Row</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Action</th><th>Destination</th><th>Moving</th><th>Idling</th><th>Stopped</th><th>Offline</th><th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="destination-rows"></tbody>
                </table>
            </div>

            <div class="chart-container glass">
                <div class="chart-header">Online Status</div>
                <div class="donut-wrapper">
                    <svg width="130" height="130" viewBox="0 0 130 130">
                        <circle cx="65" cy="65" r="55" fill="transparent" stroke="#ef4444" stroke-width="12"/>
                        <circle id="online-bar" cx="65" cy="65" r="55" fill="transparent" stroke="#22c55e" stroke-width="12" stroke-dasharray="345.5" stroke-dashoffset="345.5" stroke-linecap="round" transform="rotate(-90 65 65)"/>
                    </svg>
                    <div class="donut-inner" id="percent-text">0%</div>
                </div>
                <div class="chart-legend" id="chart-legend-text">Online: 0% | Offline: 0%</div>
            </div>
        </div>

        <div class="offline-section glass">
            <div class="table-header" style="margin-bottom: 15px;">
                <h3>OFFLINE VEHICLE DETAILS</h3>
                <button class="add-btn" onclick="addOfflineRow()">+ Add Row</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Action</th><th>Vehicle No</th><th>Last Data</th><th>Since</th><th>Location</th><th>Network</th><th>Reason</th><th>Telematics By</th>
                    </tr>
                </thead>
                <tbody id="offline-rows"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize Icons
        window.onload = () => {
            lucide.createIcons();
            autoCalc();
        };

        // 1. Refresh from Google Sheets
        function refreshDashboard() {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(function(destList) {
                    const tableBody = document.getElementById("destination-rows");
                    tableBody.innerHTML = ""; 
                    destList.forEach(dest => {
                        tableBody.innerHTML += `<tr>
                            <td><button class="del-btn" onclick="this.closest('tr').remove(); autoCalc();">âœ•</button></td>
                            <td contenteditable="true">${dest.name}</td>
                            <td contenteditable="true">${dest.moving}</td>
                            <td contenteditable="true">${dest.idling}</td>
                            <td contenteditable="true">${dest.stopped}</td>
                            <td contenteditable="true">${dest.offline}</td>
                            <td>${dest.total}</td>
                        </tr>`;
                    });
                    autoCalc();
                }).getDestinationWiseData();
            } else {
                alert("Running in Preview. Open via Kasia Tool menu in Google Sheets for live data.");
            }
        }

        // 2. Calculations for Cards & Chart
        function autoCalc() {
            let tM = 0, tI = 0, tS = 0, tO = 0, tTotal = 0;
            document.querySelectorAll('#destination-rows tr').forEach(row => {
                const m = parseInt(row.cells[2].innerText) || 0;
                const i = parseInt(row.cells[3].innerText) || 0;
                const s = parseInt(row.cells[4].innerText) || 0;
                const o = parseInt(row.cells[5].innerText) || 0;
                const rowSum = m + i + s + o;
                row.cells[6].innerText = rowSum;
                tM += m; tI += i; tS += s; tO += o; tTotal += rowSum;
            });

            document.getElementById('total-count').innerText = tTotal;
            document.getElementById('moving-count').innerText = tM;
            document.getElementById('idling-count').innerText = tI;
            document.getElementById('stopped-count').innerText = tS;
            document.getElementById('offline-count').innerText = tO;

            const onlinePer = tTotal > 0 ? Math.round(((tTotal - tO) / tTotal) * 100) : 0;
            document.getElementById('percent-text').innerText = onlinePer + "%";
            document.getElementById('online-bar').style.strokeDashoffset = 345.5 - (onlinePer / 100 * 345.5);
            document.getElementById('chart-legend-text').innerText = `Online: ${onlinePer}% | Offline: ${100-onlinePer}%`;
        }

        // 3. Image OCR Logic
        async function handleImage(input) {
    const parentRow = input.parentElement.closest('tr');
    const previewDiv = input.parentElement.querySelector('.img-preview');
    const statusLabel = input.parentElement.querySelector('.status-text');
    const networkCell = parentRow.cells[5]; 
    const file = input.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = e => { previewDiv.innerHTML = `<img src="${e.target.result}">`; previewDiv.style.display = 'block'; };
        reader.readAsDataURL(file);

        statusLabel.innerText = "Scanning Screenshot...";
        
        try {
            const result = await Tesseract.recognize(file, 'eng');
            const text = result.data.text.toLowerCase();
            
            // 1. NETWORK LOGIC (High / Medium)
            // Jungle, Ghat, Mines milne par Medium dikhayega
            if (text.includes('jungle') || text.includes('ghat') || text.includes('mines')) {
                networkCell.innerHTML = "<span style='color:#fbbf24;'>ðŸ“¶ Medium</span>";
            } else {
                networkCell.innerHTML = "<span style='color:#22c55e;'>ðŸ“¶ High</span>";
            }

            // 2. OCR DATA EXTRACTION (Status, Ignition, Battery, Voltage)
            let isOffline = text.includes('offline');
            let isMoving = text.includes('moving');
            let isStopped = text.includes('stopped');
            let isIdling = text.includes('idling');

            // Extraction patterns
            let ignOn = text.includes('ign on') || text.includes('ignition on');
            let ignOff = text.includes('ign off') || text.includes('ignition off');
            let voltZero = text.includes('v: 0') || text.includes('v 0') || text.includes('voltage 0');
            let voltPositive = !voltZero && (text.includes('v:') || text.includes('voltage'));
            
            // Battery Check (Pattern matching for low battery)
            let batLow = text.match(/([1-9]%)|(10%)/); // 1% to 10%
            let batZero = text.includes('0%');

            // 3. FINAL REASON LOGIC (As per your request)
            if (isOffline) {
                if (ignOn && voltPositive && !batLow) {
                    statusLabel.innerHTML = "<span style='color:#22c55e;'>ðŸŸ¢ Needs to be Check</span>";
                } 
                else if (ignOn && voltZero) {
                    statusLabel.innerHTML = "<span style='color:#ef4444;'>ðŸ”´ Power Cut / Wiring Issue</span>";
                }
                else if (ignOn && voltPositive && (batLow || batZero)) {
                    statusLabel.innerHTML = "<span style='color:#ea580c;'>ðŸŸ  Internal Battery Low/Damaged</span>";
                }
                else if (ignOff && voltZero && batZero) {
                    statusLabel.innerHTML = "<span style='color:#9ca3af;'>âš« Device Fully Dead/GPS Disconnect</span>";
                }
                else {
                    statusLabel.innerText = "Hardware Offline";
                }
            } 
            // 4. MAPPING OTHER STATUS AS IS
            else if (isMoving) statusLabel.innerText = "Moving";
            else if (isStopped) statusLabel.innerText = "Stopped";
            else if (isIdling) statusLabel.innerText = "Idling";
            else statusLabel.innerText = "Screenshot Analyzed";

        } catch (e) { 
            statusLabel.innerText = "Scan Error / Try Again"; 
        }
    }
}

        function addDestinationRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><button class="del-btn" onclick="this.closest('tr').remove(); autoCalc();">âœ•</button></td><td contenteditable="true">New Plant</td><td contenteditable="true">0</td><td contenteditable="true">0</td><td contenteditable="true">0</td><td contenteditable="true">0</td><td>0</td>`;
            document.getElementById('destination-rows').appendChild(tr);
        }

        function addOfflineRow() {
            const id = Date.now();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><button class="del-btn" onclick="this.closest('tr').remove();">âœ•</button></td>
                <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                <td>-</td>
                <td>
                    <div class="proof-cell">
                        <span class="status-text">Attach Screenshot</span>
                        <input type="file" class="file-input" id="r-${id}" onchange="handleImage(this)">
                        <label for="r-${id}" class="attach-btn"><i data-lucide="image"></i> Dashboard</label>
                        <div class="img-preview"></div>
                    </div>
                </td>
                <td contenteditable="true">Operator Name</td>`;
            document.getElementById('offline-rows').appendChild(tr);
            lucide.createIcons();
        }

        document.getElementById('destination-rows').addEventListener('input', autoCalc);
    </script>
</body>
</html>

